<?xml version="1.0" encoding="UTF-8"?>
<!--
   Makefile for OperaDriver.  Available tasks:

   ant          defaults to compile.
   ant compile  will compile source into class-files.
   ant clean    removes binary (/bin) directory.
   ant jar      creates a jar file in package directory (/pkg).

   Use “ant jar” for normal releases.
   
   ant test     compiles test classes and generates a test jar and runs junit tests
-->

<project basedir="." default="compile" name="OperaDriver">
  <!--
       !!!!!!!!!!!!!!! VERY IMPORTANT !!!!!!!!!!!!!!!
       Update the property below with the absolute path to a local launcher binary and gogi binary to be used for testing

  <property name="test_gogi_binary_location" value="/spartan/ramdisk/install/opera/profiles/release_tv/lingogi_release_tv"/>
  <property name="test_launcher_binary_location" value="/home/jlivermo/launcher/opera-launcher/projects/linux/launcher"/>

     Used to perform regular expression on version file.  Make sure
     that you have the package “ant-contrib” installed.
  -->
  <taskdef resource="net/sf/antcontrib/antcontrib.properties">
    <classpath>
      <pathelement location="/usr/share/java/ant-contrib.jar"/>
    </classpath>
  </taskdef>
  
  <path id="webdriver-opera.path">
    <pathelement location="bin" />
    <fileset dir="lib" includes="**/*.jar" />
  </path>
	
  <path id="pkg.dir.path">
    <pathelement location="pkg" />
    <fileset dir="pkg"/>
  </path>	
	
  <path id="test.dir.path">
    <pathelement location="test" />
    <fileset dir="test"/>
  </path>	

  <!-- Delete the bin and pkg dirs -->
  <target name="clean">
    <delete dir="bin" />
    <delete dir="pkg" />
  </target>

  <!-- Compile all classes after cleaning-->
  <target name="compile" depends="clean">
    <fileset dir="bin" />
    <mkdir dir="bin" />

    <copy includeemptydirs="false" todir="bin">
      <fileset dir="src">
      	<exclude name="**/*.launch" />
      	<exclude name="**/*.java" />
      </fileset>
    </copy>

    <javac debug="true" destdir="bin" includeantruntime="false">
      <src path="src" />
      <classpath refid="webdriver-opera.path" />
    </javac>
  </target>
	
  <!-- Build the jar -->	
  <target name="jar" depends="compile">
    <mkdir dir="pkg" />
    <loadfile srcfile="src/com/opera/core/systems/VERSION" property="versionfile" />

    <!-- Will remove new line in version file. -->
    <propertyregex property="version"
		   input="${versionfile}"
		   regexp="\n"
		   replace=""
       global="true" />  	

    <jar destfile="pkg/webdriver-opera-${version}.jar">
      <fileset dir="bin" includes="**/*.class" />
      <manifest>
      	<attribute name="Main-Class" value="com.opera.core.systems.OperaDriver" />
      	<attribute name="Implementation-Version" value="${version}" />
      </manifest>
    </jar>
  </target>	
	
  <!-- Compile any modified classes including test classes -->	
  <target name="test_compile">
    <fileset dir="bin" />
    <mkdir dir="bin" />

    <copy includeemptydirs="false" todir="bin">
      <fileset dir="src">
      	<exclude name="**/*.launch" />
      	<exclude name="**/*.java" />
      </fileset> 	
    </copy>	

    <javac debug="true" destdir="bin" includeantruntime="false">
      <src path="src" />
      <classpath refid="webdriver-opera.path" />
    </javac>
  	
    <javac debug="true" destdir="test" includeantruntime="false">
      <src path="test" />
      <classpath refid="webdriver-opera.path" />
    </javac>  	
  </target>	
	
  <!-- Build a test jar after running test_compile -->	
  <target name="test_jar" depends="test_compile">
  	<delete dir="pkg" />
    <mkdir dir="pkg" />
    <loadfile srcfile="src/com/opera/core/systems/VERSION" property="versionfile" />

    <!-- Will remove new line in version file -->
    <propertyregex property="version"
		   input="${versionfile}"
		   regexp="\n"
		   replace=""
       global="true" />  	

    <jar destfile="pkg/webdriver-opera-${version}.jar">
      <fileset dir="bin" includes="**/*.class" />
      <manifest>
      	<attribute name="Main-Class" value="com.opera.core.systems.OperaDriver" />
      	<attribute name="Implementation-Version" value="${version}" />
      </manifest>
    </jar>
  </target>	

  <!-- Run all junit tests -->
  <target name="test" depends="test_jar">			
    <junit fork="yes" haltonfailure="yes" printsummary="yes">
      <sysproperty key="test_gogi_binary_location" value="/test/ramdisk/install/opera/profiles/release_tv/lingogi_release_tv" />
      <sysproperty key="test_launcher_binary_location" value="/home/jlivermo/opera-launcher/projects/linux/launcher" />
      <classpath refid="webdriver-opera.path" />
      <classpath refid="test.dir.path" />
      <formatter type="brief" usefile="false" />
      <test name="OperaLauncherRunnerTest" />
      <test name="ScopeServicesTest" />
    </junit>
  </target>
</project>
